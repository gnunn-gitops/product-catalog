apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: client
spec:
  workspaces:
    - name: git-source
  params:
    - name: git_revision
      type: string
      default: master
    - name: git_url
      type: string
      default: https://github.com/gnunn-gitops/product-catalog-client
    - name: image_dest_url
      type: string
      description: External registry location to copy image to
      default: quay.io/gnunn/client
    - name: image_dest_tag
      type: string
      description: Tag of image to push to production
    - name: cluster
      type: string
      description: Cluster to push to
  tasks:
    - name: clone
      taskRef:
        name: git-clone
        kind: ClusterTask
      workspaces:
        - name: output
          workspace: git-source
      params:
        - name: url
          value: "$(params.git_url)"
        - name: revision
          value: "$(params.git_revision)"
        - name: deleteExisting
          value: "true"
    - name: prod-pr-deploy
      taskRef:
        name: patch-image-tag-and-pr
        kind: Task
      runAfter:
        - clone
      workspaces:
        - name: source
          workspace: git-source
      params:
        - name: dest-tag
          value: $(tasks.clone.results.commit)
        - name: filename
          value: cluster/overlays/$(params.cluster)/prod/patch-server-deployment.yaml
        - name: review-links
          value: |-
            Image Vulnerabilities: https://$(image_dest_url):$(tasks.clone.results.commit)
            Sonarqube Results: http://sonarqube-product-catalog-cicd.apps.cluster.ocplab.com/dashboard?id=com.redhat.demo%3Aproduct-catalog-client
